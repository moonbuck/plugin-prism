{{- /* Resolve the data file. */ -}}
{{- $theme_directory_file := site.Data.plugin_prism_defaults | default site.Data.plugin_prismjs_defaults -}}
{{- $plugin_directory_file := site.Data.plugin_prism.defaults | default site.Data.plugin_prismjs.defaults -}}
{{- $data := $theme_directory_file | default $plugin_directory_file -}}

{{- /* Create a map that shares the same parameter keys and the data files. */ -}}
{{- $params := dict -}}
{{- with site.Params -}}
{{- $params = dict "Theme" .prism_Theme "FontSize" .prism_FontSize "Minify" .prism_Minify "LineNumbers" .prism_LineNumbers "EnableToolbar" .prism_EnableToolbar "SoftWrap" .prism_SoftWrap "ShowLanguage" .prism_ShowLanguage "CopyButton" .prism_CopyButton "KeepMarkup" .prism_KeepMarkup "PreserveWhitespace" .prism_PreserveWhitespace "WhitespaceSettings" .prism_WhitespaceSettings -}}
{{- end -}}

{{ $keep_markup := (.keep_markup | default (($data | default $params).KeepMarkup)) | default true | string }}
{{- $keep_markup = not (and $keep_markup (eq $keep_markup "false")) -}}

{{ $preserve_whitespace := (.preserve_whitespace | default (($data | default $params).PreserveWhitespace)) | default false | string  }}
{{- $preserve_whitespace = (and $preserve_whitespace (eq $preserve_whitespace "true")) -}}

{{ $line_numbers := (.line_numbers | default (($data | default $params).LineNumbers)) | default false | string }}
{{- $line_numbers = (and $line_numbers (eq $line_numbers "true")) -}}

{{- if .inner -}}

{{- $fence_open := .inner | findRE "^[ \n\t\r]*```" -}}
{{- if $fence_open -}}
{{- $fence_open = index $fence_open 0 -}}

{{- $code := .inner | strings.TrimPrefix $fence_open -}}

{{- $language := $code | findRE "^[-a-z0-9]+" -}}
{{- if $language -}}
{{- $language = index $language 0 -}}

{{- $code = $code | strings.TrimPrefix $language -}}

{{- $fence_close := $code | findRE "```[ \n\t\r]*$" -}}
{{- if $fence_close -}}
{{- $fence_close = index $fence_close 0 -}}

{{- $code = $code | strings.TrimSuffix $fence_close -}}

{{- $class := printf "code-block language-%s" $language -}}

{{- if $line_numbers -}}
{{- $class = printf "%s line-numbers" $class -}}
{{- end -}}

{{- if $preserve_whitespace -}}
{{- $class = printf "%s no-whitespace-normalization" $class -}}
{{- end -}}

{{- if not $keep_markup -}}
{{- $class = printf "%s no-keep-markup" $class -}}
{{- end }}

{{- $attributes := "" -}}
{{- with .data_language -}}
{{- $attributes = printf "data-language='%s'" . -}}
{{- end -}}

{{- with .dependencies -}}
{{- if $attributes -}}
{{- $attributes = printf "%s data-dependencies='%s'" $attributes . -}}
{{- else -}}
{{- $attributes = printf "data-dependencies='%s'" . -}}
{{- end -}}
{{- end -}}

{{- if (isset . "soft_wrap") -}}
{{- $style := cond (eq .soft_wrap "true") "white-space:pre-wrap!important" "white-space:pre!important" -}}
{{- if $attributes -}}
{{- $attributes = printf "%s style='%s'" $attributes $style -}}
{{- else -}}
{{- $attributes = printf "style='%s'" $style -}}
{{- end -}}
{{- end -}}

{{- with $attributes -}}
{{- printf "<script type='text/plain' class='%s' %s>\n%s\n</script>" $class . (htmlUnescape $code) | safeHTML -}}
{{- else -}}
{{- printf "<script type='text/plain' class='%s'>\n%s\n</script>" $class (htmlUnescape $code) | safeHTML -}}
{{- end -}}

{{- end -}}

{{- end -}}

{{- end -}}

{{- end -}}